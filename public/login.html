<html>
    <head>
        <title>Words</title>
        
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

        <!-- Latest compiled and minified JavaScript -->
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
        
        <link rel="stylesheet" href="stylesheets/styles.css">
        
        <script
          src="http://code.jquery.com/jquery-3.2.1.min.js">
        </script>
        
        <script>
        $(document).ready(function() {
          
          $("#loginButton").click(function(e) {
                    e.preventDefault();
                    
                    postLogin();
                    console.log("logged in!");
                    getUnits();

                });
        });
        
            function postLogin() {
                var url = "/login";
                var data = {
                    user: $("#usernameField").val(),
                    password: $("#passwordField").val()
                };
                
                console.log("ABOUT TO AJAX");
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: data
                }).done(response => {
                    console.log(response);
                });
            }
        
          function getUnits() {
                //search = search.toLowerCase();
                var url = "getUnits";
                url = encodeURI(url);   //escape spaces and stuff
                var units;
                
                console.log(url);
                $.getJSON(url,function(data) {
                    //console.log(data);
                    var everything;
                    everything = "<ol>";
                    //$.each(data, function(i, item) {
                    //   everything += "<li><b>" + toTitleCase(item.stakeName) + '</b>: ' + item.stakeUnitNo ;
                    //});
                    $.each(data[0].wards, function(i, item) {
                       everything += "<li><b>" + toTitleCase(item.wardName) + '</b>: ' + item.wardUnitNo;
                    });
                    everything += "</ol>";
                    $("#unitResults").html(everything);
                    $("#searchTerm").text(data[0].stakeName);
                    //return data.responseJSON;
                })
                .done(function(data) {
                  console.log('getJSON request succeeded'); 
                  units = data;
                  console.log(units[0].wards);
                  getTeachingPools(units[0].wards);
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.log('getJSON request failed! ' + textStatus);
                    console.log("incoming"+jqXHR.responseText);
                })
                .always(function() {console.log('getJSON request ended!');
                });
            }
          
          function getTeachingPools(units) {
            console.log("Starting to get teaching pool. Units: " + units);
            for (var i = 0; i < units.length; i++) { 
              console.log(units[i].wardName +" - Admin Rights: " +units[i].userHasWardAdminRights);
              if (units[i].userHasWardAdminRights || units[i].userHasStakeAdminRights) {
                var unitNumber = units[i].wardUnitNo;
                var url = "getTeachingPool?q=" + unitNumber;
                console.log("Getting teaching pool. URL: "+url);
                
                $.getJSON(url, function(data) {
                  var everything = "<ol>";
                  $.each(data, function(i, item) {
                     everything += "<li><b>" + item.fullName + '</b>: ' + item.statusName;
                  });
                  everything += "</ol>";
                  $("#teachingPoolResults").html(everything);
                })
                .done(function() {
                      console.log('getJSON request succeeded'); 
                      
                    })
                    .fail(function(jqXHR, textStatus, errorThrown) {
                        console.log('getJSON request failed! ' + textStatus);
                        console.log("incoming"+jqXHR.responseText);
                    })
                    .always(function() {console.log('getJSON request ended!');
                    });
              }
              else {console.log(units[i].wardName + " skipped as user does not have admin rights");}
            }
          }
            
          function toTitleCase(str) {
          return str.replace(
              /\w\S*/g,
              function(txt) {
                  return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
              }
            );
          }
          
        </script>
        
    </head>
    
    <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fa fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="weather.html">Weather</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Page Header -->
    <header class="masthead">
      <div class="overlay"></div>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-md-10 mx-auto">
            <div class="page-heading">
              <h1>Login</h1>
            </div>
            <div class="page-heading">
            </div>
          </div>
        </div>
      </div>
    </header>
      
    <div class="container">
      <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto" id="SoSearchContainer">
            <form>
                USERNAME: <input type="text" id="usernameField" value="">
                <br>
                PASSWORD: <input type="password" id="passwordField" value="">
                <input id="loginButton" type="submit" value="Submit">
            </form>
            <h4 id="searchTerm">No search</h4>
            <div id="unitResults">No results</div>
            <div id="teachingPoolResults">No teaching pool</div>
        </div>
      </div>
    </div>

    </body>
    
    <!-- Footer ******************************************************************************************************************-->
      <footer>
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
              <ul class="list-inline text-center">
                <li class="list-inline-item">
                  <a href="https://www.linkedin.com/in/benson-kane/">
                  <img class="socialButton" src="../../images/?q=icons8-linkedin.svg" alt="Linkedin">
                  </a>
                </li>
                <li class="list-inline-item">
                  <a href = "https://www.instagram.com/bensondavidkane/">
                  <img class="socialButton" src="../../images/icons8-instagram.svg" alt="Instagram">
                  </a>
                </li>
                <li class="list-inline-item">
                  <a href = "https://github.com/benson-kane">
                  <img class="socialButton" src="../../images/icons8-github.svg" alt="GitHub">
                  </a>
                </li>
              </ul>
              <p>
                <a class="returnToTop" href="#top">Return to Top</a>
              </p>
              <p class="copyright text-muted" style="margin-left:auto; margin-right:auto; text-align:center;">Copyright &copy; 2018 Benson Kane</p>
            </div>
          </div>
        </div>
      </footer>
</html>